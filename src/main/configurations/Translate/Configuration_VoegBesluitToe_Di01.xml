<Module xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:noNamespaceSchemaLocation="../FrankConfig.xsd">
    <Adapter name="VoegBesluitToe_Di01"
        active="${VoegBesluitToe_Di01.Active}"
        description="">

        <Receiver name="VoegBesluitToe_Di01">
            <JavaListener name="VoegBesluitToe_Di01" />
            <JdbcErrorStorage
                name="JdbcErrorStorage"
                datasourceName="jdbc/${database.instance.name}"
                slotId="${instance.name}/voegBesluitToe" />
        </Receiver>

        <Pipeline>
            <Exits>
                <Exit name="EXIT" state="SUCCESS" />
                <Exit name="EXCEPTION" state="ERROR" />
            </Exits>

            <!-- Check if BesluitType Omschrijving is provided -->
            <XmlIfPipe 
                name="CheckIfInputMessageHasBesluitTypeOmschriving"
                xpathExpression="string-length(/voegBesluitToe_Di01/object/besluit/bst.omschrijving) > 0">
                <Forward name="then" path="StoreBesluitTypeOmschriving" />
                <Forward name="else" path="No_BesluitType_Omschrijving_Exception" />
            </XmlIfPipe>

            <XsltPipe
                name="No_BesluitType_Omschrijving_Exception"
                styleSheetName="Common/xsl/BuildError.xsl">
                <Param name="code" value="TranslationError" /> <!-- codes: TechnicalError,
                TranslationError, ConfigurationError-->
                <Param name="reason"
                    pattern="No Besluit Type Omschrijving found in the input message."
                    ignoreUnresolvablePatternElements="true" />
                <!-- <Param name="details" sessionKey="" /> -->
                <Forward name="success" path="EXCEPTION" />
                <Forward name="error" path="EXCEPTION" />
            </XsltPipe>

            <PutInSessionPipe
                name="StoreBesluitTypeOmschriving">
                <Param name="BesluitTypeOmschrijving"
                    xpathExpression="/voegBesluitToe_Di01/object/besluit/bst.omschrijving" />
                <Forward name="success" path="CallGetZgwZaak" />
            </PutInSessionPipe>

            <!-- Retrieve zgwZaak -->
            <SenderPipe
                name="CallGetZgwZaak">
                <IbisLocalSender
                    name="CallGetZgwZaakSender"
                    javaListener="GetZgwZaak">
                    <Param name="Identificatie"
                        xpathExpression="/voegBesluitToe_Di01/object/zaak/identificatie" />
                </IbisLocalSender>
                <Forward name="success" path="CheckForGetZgwZaakResult" />
                <Forward name="exception" path="UncaughtException" />
            </SenderPipe>

            <XmlIfPipe name="CheckForGetZgwZaakResult"
                xpathExpression="string-length(ZgwZaken) > 0"
            >
                <Forward name="then" path="GetSingleZgwZaakFromZgwZakenList" />
                <Forward name="else" path="UncaughtException" />
            </XmlIfPipe>

            <XsltPipe
                name="GetSingleZgwZaakFromZgwZakenList"
                styleSheetName="Common/xsl/GetSingleElementFromList.xslt"
            >
                <Forward name="success" path="StoreZgwZaak" />
                <Forward name="error" path="UncaughtException" />
            </XsltPipe>

            <!-- Retrieve and Store zgwZaakUrl and zgwZaaktypeUrl -->
            <PutInSessionPipe
                name="StoreZgwZaak">
                <Param name="ZgwZaakUrl" xpathExpression="/ZgwZaak/url" />
                <Param name="ZgwZaakTypeUrl" xpathExpression="/ZgwZaak/zaaktype" />
                <Forward name="success" path="CallGetBesluitTypen" />
            </PutInSessionPipe>

            <!-- Retrieve BesluitType -->
            <SenderPipe
                name="CallGetBesluitTypen"
                storeResultInSessionKey="GetBesluitTypenByZaakTypeResult">
                <IbisLocalSender
                    name="CallGetBesluitTypenSender"
                    javaListener="GetBesluitTypenByZaakType">
                    <Param name="ZgwZaakTypeUrl" sessionKey="ZgwZaakTypeUrl" />
                </IbisLocalSender>
                <Forward name="success" path="CheckForGetBesluitTypenByZaakTypeResult" />
                <Forward name="exception" path="UncaughtException" />
            </SenderPipe>

            <XmlIfPipe name="CheckForGetBesluitTypenByZaakTypeResult"
                xpathExpression="count(/ZgwBesluitTypen/ZgwBesluitType) > 0"
            >
                <Forward name="then" path="GetBesluitTypeMatchingOmschrijvingFromList" />
                <Forward name="else" path="No_BesluitType_By_Zaak_Exception" />
            </XmlIfPipe>

            <XsltPipe
                name="No_BesluitType_By_Zaak_Exception"
                styleSheetName="Common/xsl/BuildError.xsl">
                <Param name="code" value="TranslationError" /> <!-- codes: TechnicalError,
                TranslationError, ConfigurationError-->
                <Param name="reason" pattern="No Besluit Type found by Zaak."
                    ignoreUnresolvablePatternElements="true" />
                <!-- <Param name="details" sessionKey="" /> -->
                <Forward name="success" path="EXCEPTION" />
                <Forward name="error" path="EXCEPTION" />
            </XsltPipe>

            <XsltPipe
                name="GetBesluitTypeMatchingOmschrijvingFromList"
                styleSheetName="Common/xsl/GetElementsFromList.xslt"
                getInputFromSessionKey="GetBesluitTypenByZaakTypeResult"
                storeResultInSessionKey="GetBesluitTypeMatchingOmschrijving"
            >
                <Param name="Where" value="omschrijving" />
                <Param name="StartsWith" sessionKey="BesluitTypeOmschrijving"/>
                <Forward name="success" path="CheckForBesluitTypeResultFilteredByOmschrijving" />
                <Forward name="error" path="UncaughtException" />
            </XsltPipe>

            <XmlIfPipe name="CheckForBesluitTypeResultFilteredByOmschrijving"
                xpathExpression="count(/ZgwBesluitTypen/ZgwBesluitType) > 0">
                <Forward name="then" path="SetBesluitType" />
                <Forward name="else" path="No_BesluitType_With_This_Omschrijving_Exception" />
            </XmlIfPipe>

            <XsltPipe
                name="No_BesluitType_With_This_Omschrijving_Exception"
                getInputFromSessionKey="originalMessage"
                styleSheetName="Common/xsl/BuildError.xsl">
                <Param name="code" value="TranslationError" /> <!-- codes: TechnicalError,
                TranslationError, ConfigurationError-->
                <Param name="reason"
                    pattern="No Besluit Type found with this BesluitType Omschriving value: {BesluitTypeOmschrijving}"
                    ignoreUnresolvablePatternElements="true" />
                <!-- <Param name="details" sessionKey="" /> -->
                <Forward name="success" path="EXCEPTION" />
                <Forward name="error" path="EXCEPTION" />
            </XsltPipe>
            
            <XsltPipe
                name="SetBesluitType"
                styleSheetName="VoegBesluitToe_Di01/xsl/FilterBesluitTypenForGeldigheid.xslt"
                getInputFromSessionKey="GetBesluitTypeMatchingOmschrijving"
                storeResultInSessionKey="GetBesluitTypeResult"
                >
                <Forward name="success" path="CheckForFilteredBesluitTypeResult"/>
            </XsltPipe>

            <XmlIfPipe name="CheckForFilteredBesluitTypeResult"
                xpathExpression="count(/ZgwBesluitTypen/ZgwBesluitType) = 1">
                <Forward name="then" path="GetSingleBesluitTypeFromList" />
                <Forward name="else" path="No_Valid_BesluitType_Exception" />
            </XmlIfPipe>

            <XsltPipe
                name="No_Valid_BesluitType_Exception"
                getInputFromSessionKey="originalMessage"
                styleSheetName="Common/xsl/BuildError.xsl">
                <Param name="code" value="TranslationError" /> <!-- codes: TechnicalError,
                TranslationError, ConfigurationError-->
                <Param name="reason"
                    pattern="No or not unique Besluit Type found"
                    ignoreUnresolvablePatternElements="true" />
                <!-- <Param name="details" sessionKey="" /> -->
                <Forward name="success" path="EXCEPTION" />
                <Forward name="error" path="EXCEPTION" />
            </XsltPipe>

            <XsltPipe
                name="GetSingleBesluitTypeFromList"
                styleSheetName="Common/xsl/GetSingleElementFromList.xslt"
                getInputFromSessionKey="GetBesluitTypeResult"
            >
                <Forward name="success" path="StoreZgwBesluitTypeUrl" />
                <Forward name="error" path="UncaughtException" />
            </XsltPipe>

            <PutInSessionPipe
                name="StoreZgwBesluitTypeUrl">
                <Param name="ZgwBesluitType" xpathExpression="/ZgwBesluitType/url" />
                <Forward name="success" path="GetGlobalConfigFromLocalFS" />
            </PutInSessionPipe>

            <!-- End of Retrieve BesluitType-->

            <!-- Get Rsin -->
            <SenderPipe
                name="GetGlobalConfigFromLocalFS"
                storeResultInSessionKey="GlobalConfig"
            >
                <IbisLocalSender
                    name="CallImportFromLocalFS"
                    javaListener="ImportFromLocalFS"
                >
                    <Param name="FileName" value="${FilePath_1}" />
                </IbisLocalSender>
                <Forward name="success" path="CallGetRsin" />
                <Forward name="exception" path="UncaughtException" />
            </SenderPipe>

            <SenderPipe
                name="CallGetRsin"
                storeResultInSessionKey="Rsin">
                <IbisLocalSender
                    name="CallGetRsinSender"
                    javaListener="GetRsinByGemeenteCode">
                    <Param name="GemeenteCode" sessionKey="originalMessage"
                        xpathExpression="/*/stuurgegevens/zender/organisatie" />
                </IbisLocalSender>
                <Forward name="success" path="CreateBesluitBody" />
                <Forward name="exception" path="UncaughtException" />
            </SenderPipe>

            <XsltPipe
                name="CreateBesluitBody"
                getInputFromSessionKey="originalMessage"
                storeResultInSessionKey="BesluitBody"
                removeNamespaces="true"
                skipEmptyTags="true"
                styleSheetName="Zgw/Besluiten/Model/ZgwBesluit.xslt"
                >
                <Param name="VerantwoordelijkeOrganisatie" sessionKey="Rsin" xpathExpression="/RSIN" />
                <Param name="Besluittype" sessionKey="ZgwBesluitType"/>
                <Param name="Zaak" sessionKey="ZgwZaakUrl"/>
                <Param name="ZdsBesluit" xpathExpression="/voegBesluitToe_Di01/object/besluit[@entiteittype='BSL']"></Param>
                <Param name="ZdsZaak" xpathExpression="/voegBesluitToe_Di01/object/zaak[@entiteittype='ZAK']"></Param>
                <Forward name="success" path="CallPostBesluit"/>
            </XsltPipe>

            <SenderPipe
                name="CallPostBesluit">
                <IbisLocalSender
                    name="CallPostBesluitSender"
                    javaListener="PostZgwBesluitAdapter">
                </IbisLocalSender>
                <Forward name="success" path="EXIT"/>
                <Forward name="exception" path="UncaughtException" />
            </SenderPipe> 

            <XsltPipe
                name="UncaughtException"
                emptyInputReplacement="&lt;EmptyInput/&gt;"
                styleSheetName="Common/xsl/BuildError.xsl">
                <Param name="code" value="TechnicalError" /> <!-- codes: TechnicalError,
                TranslationError, ConfigurationError-->
                <Param name="reason" pattern="Uncaught exception" />
                <!-- <Param name="details" sessionKey="" /> -->
                <Param name="detailsXml" type="DOMDOC" />
                <Forward name="success" path="EXCEPTION" />
                <Forward name="exception" path="EXCEPTION" />
            </XsltPipe>
        </Pipeline>
    </Adapter>
</Module>